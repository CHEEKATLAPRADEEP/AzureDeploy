{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "userName": {
            "type": "string",
            "defaultValue": "azureadmin",
            "metadata": {
                "description": "Username for the guest OS"
            }
        },
        "pwd": {
            "type": "securestring",
            "metadata": {
                "description": "user password"
            }
        },
        "sqlEndpointName": {
            "type": "string"
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },
        "enablePremiumManagement": {
            "type": "string",
            "allowedValues": [
                "Yes",
                "No"
            ]
        }
    },
    "variables": {
        "vmName": "vm",
        "virtualNetworkName": "sql",
        "vnetID": "[resourceId('Microsoft.Network/virtualnetworks', variables('virtualnetworkname'))]",
        "subnetname": "sql-subnet",
        "addressPrefix": "192.168.0.0/16",
        "subnetPrefix": "192.168.0.0/24",
        "subnetRef": "[concat(variables('vnetID'),'/subnets/', variables('subnetname'))]",
        "nodeCount": 3,
        "windowsOffer": "WindowsServer",
        "windowsSku": "2016-Datacenter-with-Containers",
        "windowsPublisher": "MicrosoftWindowsServer",
        "availabilitySetName": "[concat(variables('vmName'), '-', 'avset')]",
        "availabilitySetId": {
            "id": "[resourceId('Microsoft.Compute/availabilitySets', variables('availabilitySetName'))]"
        },
        "lbName": "sfLoadBalancer",
        "lbIpName": "sfLbIp",
        "lbID": "[resourceId('Microsoft.Network/loadBalancers/', variables('lbName'))]",
        "frontEndIPConfigID": "[concat(variables('lbID'),'/frontendIPConfigurations/LoadBalancerFrontEnd')]",
        "lbPoolID": "[concat(variables('lbID'),'/backendAddressPools/BackendPool1')]",
        "lbRDPProbeID": "[concat(variables('lbID'),'/probes/rdpProbe')]",
        "lbSFProbeID": "[concat(variables('lbID'), '/probes/sfProbe')]",
        "lbSQLProbeID": "[concat(variables('lbID'), '/probes/sqlProbe')]",
        "lbSfClProbeID": "[concat(variables('lbID'),'/probes/sfClProbe')]",
        "scripts": {
            "prepareNodes": "https://raw.githubusercontent.com/krnese/AzureDeploy/master/ARM/alpha/setup.ps1"
        },
        "omsWorkspaceName": "[concat(take(parameters('sqlEndpointName'), 5), uniqueString('ws'))]",
        "omsAutomationName": "[concat(take(parameters('sqlEndpointName'), 5), uniqueString('aa'))]",
        "logAnalyticsLocationMap": {
            "eastasia": "southeastasia",
            "southeastasia": "southeastasia",
            "centralus": "westcentralus",
            "eastus": "eastus",
            "eastus2": "eastus",
            "westus": "westcentralus",
            "northcentralus": "westcentralus",
            "southcentralus": "westcentralus",
            "northeurope": "westeurope",
            "westeurope": "westeurope",
            "japanwest": "southeastasia",
            "japaneast": "southeastasia",
            "brazilsouth": "eastus",
            "australiaeast": "australiasoutheast",
            "australiasoutheast": "australiasoutheast",
            "southindia": "southeastasia",
            "centralindia": "southeastasia",
            "westindia": "southeastasia",
            "canadacentral": "eastus",
            "canadaeast": "eastus",
            "uksouth": "westeurope",
            "ukwest": "westeurope",
            "westcentralus": "westcentralus",
            "westus2": "westcentralus",
            "koreacentral": "southeastasia",
            "koreasouth": "southeastasia",
            "eastus2euap": "eastus"
        },
        "omsWorkspaceRegion": "[variables('logAnalyticsLocationMap')[parameters('location')]]",
        "batch1": {
            "solutions": [
                {
                    "name": "[concat('Security', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "Security"
                },
                {
                    "name": "[concat('ServiceMap', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "ServiceMap"
                },
                {
                    "name": "[concat('AgentHealthAssessment', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "AgentHealthAssessment"
                },
                {
                    "name": "[concat('ChangeTracking', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "ChangeTracking"
                },
                {
                    "name": "[concat('Updates', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "Updates"
                },
                {
                    "name": "[concat('AlertManagement', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "AlertManagement"
                },
                {
                    "name": "[concat('AntiMalware', '(', variables('omsWorkspaceName'), ')')]",
                    "marketplaceName": "AntiMalware"
                }
            ]
        },
        "assets": {
            "psModules": {
                "xPSDSC": {
                    "name": "xPSDesiredStateConfiguration",
                    "uri": "https://devopsgallerystorage.blob.core.windows.net/packages/xpsdesiredstateconfiguration.3.9.0.nupkg"
                }
            },
            "aaVariables": {
                "OMSWorkspaceId": {
                    "name": "OMSWorkspaceId",
                    "description": "Workspace ID for the Log Analytics workspace"
                },
                "OMSWorkspaceKey": {
                    "name": "OMSWorkspaceKey",
                    "description": "Primary key for the Log Analytics workspace"
                },
                "AzureSubscriptionId": {
                    "name": "SubscriptionId",
                    "description": "Azure subscription Id"
                }
            },
            "dsc": {
                "omsConfig": {
                    "name": "OMS",
                    "description": "DSC configuration for installing and configuring OMS agent",
                    "uri": "[uri(deployment().properties.templateLink.uri, 'scripts/oms.ps1')]"
                },
                "omsService": {
                    "name": "OMSSERVICE",
                    "description": "DSC configuration for keeping the OMS agent in a running state",
                    "uri": "[uri(deployment().properties.templateLink.uri, 'scripts/omsservice.ps1')]"
                },
                "omsAsrComplete": {
                    "name": "OMSASR",
                    "description": "DSC configuration for installing the OMS and Azure agent for protected machines for ASR",
                    "uri": "[uri(deployment().properties.templateLink.uri, 'scripts/omsasr.ps1')]"
                }
            },
            "guids": {
                "guid1": "[guid(parameters('sqlEndpointName'))]",
                "guid2": "[guid(parameters('userName'))]",
                "guid3": "[guid(resourceGroup().id, deployment().name)]"
            }
        },
        "modulesUrl": "[uri(deployment().properties.templateLink.uri, 'scripts/UpdateLCMforAAPull.zip')]",
        "configurationFunction": "UpdateLCMforAAPull.ps1\\ConfigureLCMforAAPull",
        "configurationMode": "ApplyAndMonitor",
        "configurationModeFrequencyMins": 15,
        "refreshFrequencyMins": 30,
        "rebootNodeIfNeeded": true,
        "actionAfterReboot": "ContinueConfiguration",
        "allowModuleOverwrite": true,
        "configName": "OMSSERVICE.localhost"        
    },
    "resources": [
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2017-04-01",
            "name": "[concat('ip', copyindex(0))]",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "ipCopy",
                "count": "[variables('nodeCount')]"
            },
            "properties": {
                "publicIPallocationmethod": "Dynamic"
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2017-04-01",
            "name": "[variables('lbIpName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "publicIPallocationmethod": "Dynamic",
                "dnsSettings": {
                    "domainNameLabel": "[parameters('sqlEndpointName')]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2017-04-01",
            "name": "[concat('nic', copyindex(0))]",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "nicCopy",
                "count": "[variables('nodeCount')]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', 'ip', copyindex(0))]",
                "[concat('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
                "[resourceId('Microsoft.Network/loadBalancers/', variables('lbName'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', concat('ip', copyindex(0)))]"
                            },
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            },
                            "loadBalancerBackendAddressPools": [
                                {
                                    "id": "[concat(variables('lbID'), '/backendAddressPools/backendPool1')]"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualnetworks",
            "apiVersion": "2017-04-01",
            "name": "[variables('virtualNetworkName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "addressSpace": {
                    "addressprefixes": [
                        "[variables('addressprefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('subnetname')]",
                        "properties": {
                            "addressprefix": "[variables('subnetprefix')]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2018-01-01",
            "name": "[variables('lbName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('lbIpName'))]"
            ],
            "sku": {
                "name": "Basic"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "LoadBalancerFrontEnd",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('lbIpName'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "BackendPool1"
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "rdp",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigID')]"
                            },
                            "frontendPort": 3389,
                            "backendPort": 3389,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 4,
                            "protocol": "Tcp",
                            "loadDistribution": "Default",
                            "backendAddressPool": {
                                "id": "[variables('lbPoolID')]"
                            },
                            "probe": {
                                "id": "[variables('lbRDPProbeID')]"
                            }
                        }
                    },
                    {
                        "name": "sf_manager",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigID')]"
                            },
                            "frontendPort": 19080,
                            "backendPort": 19080,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 4,
                            "protocol": "Tcp",
                            "loadDistribution": "Default",
                            "backendAddressPool": {
                                "id": "[variables('lbPoolID')]"
                            },
                            "probe": {
                                "id": "[variables('lbSFProbeID')]"
                            }
                        }
                    },
                    {
                        "name": "sf_cluster",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigID')]"
                            },
                            "frontendPort": 19000,
                            "backendPort": 19000,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 4,
                            "protocol": "Tcp",
                            "loadDistribution": "Default",
                            "backendAddressPool": {
                                "id": "[variables('lbPoolID')]"
                            },
                            "probe": {
                                "id": "[variables('lbSfClProbeID')]"
                            }
                        }
                    },
                    {
                        "name": "sqlserver",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('frontEndIPConfigID')]"
                            },
                            "frontendPort": 1433,
                            "backendPort": 1433,
                            "enableFloatingIP": false,
                            "idleTimeoutInMinutes": 4,
                            "protocol": "Tcp",
                            "loadDistribution": "Default",
                            "backendAddressPool": {
                                "id": "[variables('lbPoolID')]"
                            },
                            "probe": {
                                "id": "[variables('lbSQLProbeID')]"
                            }
                        }
                    }
                ],
                "probes": [
                    {
                        "name": "rdpProbe",
                        "properties": {
                            "protocol": "Tcp",
                            "port": 3389,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    },
                    {
                        "name": "sfProbe",
                        "properties": {
                            "protocol": "Http",
                            "port": 19080,
                            "requestPath": "/",
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    },
                    {
                        "name": "sfClProbe",
                        "properties": {
                            "protocol": "Tcp",
                            "port": 19000,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    },
                    {
                        "name": "sqlProbe",
                        "properties": {
                            "protocol": "Tcp",
                            "port": 1433,
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ],
                "inboundNatRules": [],
                "outboundNatRules": [],
                "inboundNatPools": []
            }
        },
        {
            "type": "Microsoft.Compute/availabilitySets",
            "apiVersion": "2017-03-30",
            "name": "[variables('availabilitySetName')]",
            "location": "[resourceGroup().location]",
            "properties": {
                "platformFaultDomainCount": 3,
                "platformUpdateDomainCount": 3
            },
            "sku": {
                "name": "Aligned"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2017-03-30",
            "name": "[concat(variables('vmName'), copyIndex(0))]",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "vmCopy",
                "count": "[variables('nodeCount')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkinterfaces/', concat('nic', copyIndex(0)))]",
                "[resourceId('Microsoft.Compute/availabilitySets/', variables('availabilitySetName'))]"
            ],
            "properties": {
                "availabilitySet": "[variables('availabilitySetId')]",
                "hardwareprofile": {
                    "vmsize": "Standard_DS3_v2"
                },
                "osProfile": {
                    "computername": "[concat(variables('vmName'), copyIndex(0))]",
                    "adminusername": "[parameters('username')]",
                    "adminpassword": "[parameters('pwd')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "[variables('windowsPublisher')]",
                        "offer": "[variables('windowsOffer')]",
                        "version": "latest",
                        "sku": "[variables('windowsSku')]"
                    },
                    "osdisk": {
                        "name": "[concat(variables('vmName'), copyIndex(0))]",
                        "createOption": "FromImage",
                        "managedDisk": {
                            "storageAccountType": "Premium_LRS"
                        },
                        "caching": "ReadWrite",
                        "diskSizeGB": 128
                    }
                },
                "networkprofile": {
                    "networkinterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkinterfaces', concat('nic', copyindex(0)))]"
                        }
                    ]
                }
            },
            "resources": [
                {
                    "type": "extensions",
                    "apiVersion": "2017-03-30",
                    "name": "setup",
                    "location": "[resourceGroup().location]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/', concat(variables('vmName'), copyIndex(0)))]"
                    ],
                    "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.9",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                            "fileUris": [
                                "[variables('scripts').prepareNodes]"
                            ],
                            "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ', 'setup.ps1')]"
                        }
                    }
                },
                {
                    "type": "extensions",
                    "apiVersion": "2017-03-30",
                    "name": "OMS",
                    "location": "[resourceGroup().location]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/', concat(variables('vmName'), copyIndex(0)))]"
                    ],
                    "properties": {
                        "autoUpgradeMinorVersion": true,
                        "typeHandlerVersion": "1.0",
                        "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                        "type": "MicrosoftMonitoringAgent",
                        "settings": {
                            "workspaceId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2017-03-15-preview').customerId]",
                            "azureResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', concat(variables('vmname'), copyIndex(0)))]"
                        },
                        "protectedSettings": {
                            "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2017-03-15-preview').primarySharedKey]"
                        }
                    }                    
                }
            ]
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(variables('vmName'), copyIndex(), '/DSC')]",
            "apiVersion": "2017-03-30",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "dscCopy",
                "count": "[variables('nodeCount')]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines/', concat(variables('vmName'), copyIndex(0)))]"
            ],
            "properties": {
                "publisher": "Microsoft.Powershell",
                "type": "DSC",
                "typeHandlerVersion": "2.19",
                "autoUpgradeMinorVersion": true,
                "protectedSettings": {
                    "Items": {
                        "registrationKeyPrivate": "[listKeys(resourceId('Microsoft.Automation/automationAccounts/', variables('omsAutomationName')), '2015-01-01-preview').Keys[0].value]"
                    }
                },
                "settings": {
                    "ModulesUrl": "[variables('modulesUrl')]",
                    "SasToken": "",
                    "ConfigurationFunction": "[variables('configurationFunction')]",
                    "Properties": [
                        {
                            "Name": "RegistrationKey",
                            "Value": {
                                "UserName": "PLACEHOLDER_DONOTUSE",
                                "Password": "PrivateSettingsRef:registrationKeyPrivate"
                            },
                            "TypeName": "System.Management.Automation.PSCredential"
                        },
                        {
                            "Name": "RegistrationUrl",
                            "Value": "[reference(resourceId('Microsoft.Automation/automationAccounts/', variables('omsAutomationName')), '2015-01-01-preview').registrationUrl]",
                            "TypeName": "System.String"
                        },
                        {
                            "Name": "NodeConfigurationName",
                            "Value": "[variables('configName')]",
                            "TypeName": "System.String"
                        },
                        {
                            "Name": "ConfigurationMode",
                            "Value": "[variables('configurationMode')]",
                            "TypeName": "System.String"
                        },
                        {
                            "Name": "ConfigurationModeFrequencyMins",
                            "Value": "[variables('configurationModeFrequencyMins')]",
                            "TypeName": "System.Int32"
                        },
                        {
                            "Name": "RefreshFrequencyMins",
                            "Value": "[variables('refreshFrequencyMins')]",
                            "TypeName": "System.Int32"
                        },
                        {
                            "Name": "RebootNodeIfNeeded",
                            "Value": "[variables('rebootNodeIfNeeded')]",
                            "TypeName": "System.Boolean"
                        },
                        {
                            "Name": "ActionAfterReboot",
                            "Value": "[variables('actionAfterReboot')]",
                            "TypeName": "System.String"
                        },
                        {
                            "Name": "AllowModuleOverwrite",
                            "Value": "[variables('allowModuleOverwrite')]",
                            "TypeName": "System.Boolean"
                        }
                    ]
                }
            }
        },        
        {
            "apiVersion": "2017-03-15-preview",
            "location": "[variables('omsWorkspaceRegion')]",
            "name": "[variables('omsWorkspaceName')]",
            "type": "Microsoft.OperationalInsights/workspaces",
            "properties": {
                "sku": {
                    "name": "pernode"
                }
            },
            "resources": [
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk1",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Avg Disk sec/Read"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk2",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Avg Disk sec/Write"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk3",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Current Disk Queue Lenght"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk4",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Disk Reads/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk5",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Disk Transfers/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk6",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Disk Writes/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk7",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Free Megabytes"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "LogicalDisk8",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "LogicalDisk",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "% Free Space"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Memory1",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Available MBytes"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Memory2",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Memory",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "% Committed Bytes In Use"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Network1",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Network Adapter",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Bytes Received/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Network2",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Network Adapter",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Bytes Sent/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Network3",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Network Adapter",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Bytes Total/sec"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "CPU1",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "Processor",
                        "instanceName": "_Total",
                        "intervalSeconds": 10,
                        "counterName": "% Processor Time"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "CPU2",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsPerformanceCounter",
                    "properties": {
                        "objectName": "System",
                        "instanceName": "*",
                        "intervalSeconds": 10,
                        "counterName": "Processor Queue Lenght"
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "System",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsEvent",
                    "properties": {
                        "eventLogName": "System",
                        "eventTypes": [
                            {
                                "eventType": "Error"
                            },
                            {
                                "eventType": "Warning"
                            }
                        ]
                    }
                },
                {
                    "apiVersion": "2015-11-01-preview",
                    "type": "datasources",
                    "name": "Application",
                    "dependsOn": [
                        "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
                    ],
                    "kind": "WindowsEvent",
                    "properties": {
                        "eventLogName": "Application",
                        "eventTypes": [
                            {
                                "eventType": "Error"
                            },
                            {
                                "eventType": "Warning"
                            }
                        ]
                    }
                }
            ]
        },
        {
            "apiVersion": "2015-11-01-preview",
            "type": "Microsoft.OperationsManagement/solutions",
            "name": "[concat(variables('batch1').solutions[copyIndex()].Name)]",
            "location": "[variables('omsWorkspaceRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName'))]"
            ],
            "copy": {
                "name": "solutionCopy",
                "count": "[length(variables('batch1').solutions)]"
            },
            "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('omsWorkspaceName'))]"
            },
            "plan": {
                "name": "[variables('batch1').solutions[copyIndex()].name]",
                "product": "[concat('OMSGallery/', variables('batch1').solutions[copyIndex()].marketplaceName)]",
                "promotionCode": "",
                "publisher": "Microsoft"
            }
        },
        {
            "name": "[variables('omsAutomationName')]",
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2015-01-01-preview",
            "location": "[variables('omsWorkspaceRegion')]",
            "properties": {
                "sku": {
                    "name": "OMS"
                }
            },
            "resources": [
                {
                    "name": "[variables('assets').aaVariables.OMSWorkspaceId.name]",
                    "type": "variables",
                    "apiVersion": "2015-01-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.OMSWorkspaceId.description]",
                        "value": "[concat('\"',reference(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2015-11-01-preview').customerId,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.OMSWorkspaceKey.name]",
                    "type": "variables",
                    "apiVersion": "2015-01-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "Remote file for the passphrase",
                        "value": "[concat('\"',listKeys(resourceId('Microsoft.OperationalInsights/workspaces/', variables('omsWorkspaceName')), '2015-11-01-preview').primarySharedKey,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').aaVariables.AzureSubscriptionId.name]",
                    "type": "variables",
                    "apiVersion": "2015-01-01-preview",
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]"
                    ],
                    "tags": {},
                    "properties": {
                        "description": "[variables('assets').aaVariables.AzureSubscriptionId.description]",
                        "value": "[concat('\"',subscription().subscriptionId,'\"')]"
                    }
                },
                {
                    "name": "[variables('assets').psModules.xPSDSC.name]",
                    "type": "Modules",
                    "apiVersion": "2015-01-01-preview",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'), '/Variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'), '/Variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]"
                    ],
                    "properties": {
                        "contentLink": {
                            "uri": "[variables('assets').psModules.xPSDSC.uri]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').dsc.omsService.name]",
                    "type": "Configurations",
                    "apiVersion": "2015-01-01-preview",
                    "location": "[variables('omsWorkspaceRegion')]",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'), '/Variables/', variables('assets').aaVariables.OMSWorkspaceId.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'), '/Variables/', variables('assets').aaVariables.OMSWorkspaceKey.name)]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'), '/Modules/', variables('assets').psModules.xPSDSC.name)]"
                    ],
                    "properties": {
                        "logVerbose": "false",
                        "description": "[variables('assets').dsc.omsService.description]",
                        "state": "Published",
                        "overwrite": "true",
                        "source": {
                            "type": "uri",
                            "Value": "[variables('assets').dsc.omsService.uri]"
                        }
                    }
                },
                {
                    "name": "[variables('assets').guids.guid3]",
                    "type": "Compilationjobs",
                    "apiVersion": "2015-01-01-preview",
                    "tags": {},
                    "dependsOn": [
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'))]",
                        "[concat('Microsoft.Automation/automationAccounts/', variables('omsAutomationName'),'/Configurations/', variables('assets').dsc.omsService.name)]"
                    ],
                    "properties": {
                        "configuration": {
                            "name": "[variables('assets').dsc.omsService.name]"
                        }
                    }
                }
            ]
        }

    ],
    "outputs": {
        "endpoint": {
            "type": "string",
            "value": "[reference(variables('lbIpName'), '2017-04-01').dnsSettings.fqdn]"
        },
        "premiumManagement": {
            "type": "string",
            "value": "[parameters('enablePremiumManagement')]"
        }
    }
}